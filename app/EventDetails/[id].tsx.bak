import React, { useEffect, useState } from 'react';
import {
  View,
  Text,
  ScrollView,
  Pressable,
  ActivityIndicator,
  Linking,
  Platform,
} from 'react-native';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Ionicons } from '@expo/vector-icons';
import { LinearGradient } from 'expo-linear-gradient';

const SERVER_URL = process.env.EXPO_PUBLIC_API_URL;

interface Club {
  _id: string;
  name: string;
  description?: string;
  logo?: string;
}

interface Event {
  _id: string;
  title: string;
  description?: string;
  category: string;
  venue: string;
  date: string;
  time: string;
  maxParticipants: number;
  registrationFee: number;
  requiresTeam: boolean;
  status: string;
  unstopLink?: string;
  club?: string | null;
}

export default function EventDetails() {
  const { id } = useLocalSearchParams();
  const router = useRouter();
  const [event, setEvent] = useState<Event | null>(null);
  const [club, setClub] = useState<Club | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchEventDetails();
  }, [id]);

  const fetchEventDetails = async () => {
    try {
      const response = await fetch(`${SERVER_URL}/api/events/${id}`);
      const json = await response.json();
      if (json.status === true && json.data) {
        setEvent(json.data);
        if (json.data.club) {
          fetchClubDetails(json.data.club);
        }
      }
    } catch (error) {
      if (__DEV__) console.error("Error fetching event details");
    } finally {
      setLoading(false);
    }
  };

  const fetchClubDetails = async (clubId: string) => {
    try {
      const response = await fetch(`${SERVER_URL}/api/clubs/${clubId}`);
      const json = await response.json();
      if (json.status === true && json.data) {
        setClub(json.data);
      }
    } catch (error) {
      if (__DEV__) console.error("Error fetching club details");
    }
  };

  const handleRegister = async () => {
    // Replace with your actual Unstop URL or a field from the DB
    const unstopUrl = event?.unstopLink || "https://unstop.com";

    const supported = await Linking.canOpenURL(unstopUrl);

    if (supported) {
      await Linking.openURL(unstopUrl);
    } else {
      await Linking.openURL(unstopUrl);
    }
  };

  if (loading) {
    return (
      <SafeAreaView className="flex-1 bg-[#0E0929] justify-center items-center">
        <ActivityIndicator size="large" color="#92ACFF" />
      </SafeAreaView>
    );
  }

  if (!event) return null;

  const eventDate = new Date(event.date).toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
  
  return (
    <SafeAreaView className="flex-1 bg-[#0E0929]">
      <View className="flex-row items-center px-5 py-4 border-b border-[rgba(146,172,255,0.15)]">
        <Pressable
          onPress={() => router.back()}
          style={({ pressed }) => ({ opacity: pressed ? 0.7 : 1, transform: [{ scale: pressed ? 0.92 : 1 }] })}
        >
          <LinearGradient
            colors={['rgba(146, 172, 255, 0.25)', 'rgba(146, 172, 255, 0.08)']}
            start={{ x: 0, y: 0 }}
            end={{ x: 1, y: 1 }}
            style={{ width: 44, height: 44, borderRadius: 14, padding: 1 }}
          >
            <View style={{ flex: 1, backgroundColor: 'rgba(14, 9, 41, 0.9)', borderRadius: 13, alignItems: 'center', justifyContent: 'center' }}>
              <Ionicons name="chevron-back" size={22} color="#92ACFF" />
            </View>
          </LinearGradient>
        </Pressable>
        <Text className="text-white text-xl font-black ml-4 uppercase tracking-tighter" style={{ fontFamily: 'Orbitron_700Bold' }}>Event Details</Text>
      </View>

      <ScrollView showsVerticalScrollIndicator={false} className="flex-1 px-6">
        <View className="mt-8 self-start bg-[rgba(146,172,255,0.15)] px-4 py-1 rounded-full border border-[rgba(146,172,255,0.4)]">
          <Text className="text-[#92ACFF] font-black uppercase text-xs tracking-widest">{event.category}</Text>
        </View>

        <Text className="text-[#FFFFFF] text-5xl font-black italic uppercase tracking-tighter mt-4 leading-[50px]">
          {event.title}
        </Text>

        <View className="flex-row items-center mt-4">
          <View className="w-2 h-2 rounded-full bg-[#92ACFF] mr-2" />
          <Text className="text-[#92ACFF] font-bold uppercase text-xs tracking-widest">Active / Registration Open</Text>
        </View>

        <View className="mt-10 flex-row flex-wrap justify-between">
          <DetailBlock icon="calendar" label="Date" value={eventDate} />
          <DetailBlock icon="time" label="Time" value={event.time} />
          <DetailBlock icon="location" label="Venue" value={event.venue} />
          <DetailBlock icon="people" label="Participation" value={event.requiresTeam ? "Team Event" : "Solo Entry"} />
          <DetailBlock icon="person-add" label="Capacity" value={`${event.maxParticipants} Slots`} />
          <DetailBlock icon="wallet" label="Entry Fee" value={event.registrationFee > 0 ? `â‚¹${event.registrationFee}` : "Complimentary"} />
        </View>

        <View className="mt-10 border-t border-[rgba(146,172,255,0.2)] pt-8 pb-20">
          <Text className="text-[rgba(146,172,255,0.6)] font-black uppercase text-xs tracking-[3px] mb-4">Event Description</Text>
          <Text className="text-[#FFFFFF] text-lg leading-7 font-medium mb-10">
            {event.description || "No tactical briefing provided for this event. Prepare for standard operational procedures."}
          </Text>

          {club && (
            <View className="border-t border-[rgba(146,172,255,0.2)] pt-8">
              <Text className="text-[rgba(146,172,255,0.6)] font-black uppercase text-xs tracking-[3px] mb-4">Organized By</Text>
              <View className="bg-[rgba(146,172,255,0.1)] p-4 rounded-3xl border border-[rgba(146,172,255,0.3)] flex-row items-center">
                <View className="w-12 h-12 bg-[rgba(146,172,255,0.2)] rounded-full items-center justify-center mr-4 border border-[rgba(146,172,255,0.4)]">
                  <Ionicons name="people" size={24} color="#92ACFF" />
                </View>
                <View className="flex-1">
                  <Text className="text-[#FFFFFF] text-lg font-black italic uppercase tracking-tighter">
                    {club.name}
                  </Text>
                  {club.description && (
                    <Text className="text-[rgba(146,172,255,0.6)] text-xs font-medium mt-1" numberOfLines={2}>
                      {club.description}
                    </Text>
                  )}
                </View>
              </View>
            </View>
          )}
        </View>
      </ScrollView>

      <View className="px-6 py-6 border-t border-[rgba(146,172,255,0.2)] bg-[#0E0929]">
        <Pressable
          onPress={handleRegister}
          className="bg-[#92ACFF] py-5 rounded-3xl flex-row justify-center items-center shadow-lg shadow-[rgba(146,172,255,0.4)]"
          style={({ pressed }) => ({ opacity: pressed ? 0.8 : 1 })}
        >
          <Text className="text-[#0E0929] font-black italic uppercase text-lg tracking-widest mr-2">Register Now</Text>
          <Ionicons name="medal" size={20} color="#0E0929" />
        </Pressable>
      </View>
    </SafeAreaView>
  );
}

const DetailBlock = ({ icon, label, value }: { icon: any, label: string, value: string }) => (
  <View className="w-[48%] bg-[rgba(146,172,255,0.1)] border border-[rgba(146,172,255,0.3)] p-4 rounded-3xl mb-4">
    <View className="flex-row items-center mb-1">
      <Ionicons name={icon} size={14} color="#92ACFF" />
      <Text className="text-[rgba(146,172,255,0.6)] font-black uppercase text-[9.5px] tracking-widest ml-2">{label}</Text>
    </View>
    <Text className="text-[#FFFFFF] font-bold text-[14px]" numberOfLines={1}>{value}</Text>
  </View>
);